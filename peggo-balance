#!/usr/bin/env python
import sys, requests, getpass, json

class AuthError(Exception):
    pass

def getSession(username, password):
    r=requests.post("https://efare.winnipegtransit.com/e-Fare/doLogin.html",
            data={
                "returnUrl": "",
                "userId":
                username, "password":
                password
                },
            allow_redirects=False
            )
    if(r.status_code == 302):
        return r.cookies
    elif(r.status_code == 200):
        raise AuthError("Incorrect Username or Password")
    else:
        r.raise_for_status()

def getData(session):
    return requests.get("https://efare.winnipegtransit.com/e-Fare/service/v1/cards/", cookies=session).json()

def printData(data):
    print(json.dumps(data, indent="\t", sort_keys=True))

try:
    session=getSession(sys.argv[1], getpass.getpass())
except AuthError as e:
    print(e)
    sys.exit(2)
printData(getData(session))
